<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMPOSTOR - BATTLE ROYALE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0a0a0f; --card: #161625; --accent: #ff0040; --blue: #00e0ff; --text: #fff; --gray: #252535; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        .app-container { width: 100%; max-width: 500px; height: 100%; display: flex; flex-direction: column; border: 1px solid #222; }
        
        /* PANTALLAS */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; animation: fadeIn 0.2s; }
        .active { display: flex; }
        
        .header { flex-shrink: 0; text-align: center; padding-bottom: 15px; }
        .content { flex: 1; overflow-y: auto; padding-bottom: 15px; scrollbar-width: none; }
        .footer { flex-shrink: 0; padding: 10px 0; background: var(--bg); border-top: 1px solid #222; }

        /* UI */
        h1 { font-size: 2.8rem; color: var(--accent); margin: 0; text-shadow: 0 0 15px rgba(255,0,64,0.4); }
        .btn { width: 100%; padding: 18px; margin-bottom: 10px; border-radius: 12px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; color: #fff; text-transform: uppercase; transition: 0.1s; }
        .btn-main { background: var(--accent); box-shadow: 0 4px 0 #900; }
        .btn-main:active { transform: translateY(3px); box-shadow: none; }
        .btn-sec { background: var(--blue); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid #444; color: #888; }
        .btn-disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        
        input { width: 100%; padding: 16px; border-radius: 12px; background: #111; color: #fff; border: 2px solid #333; text-align: center; font-size: 1.1rem; outline: none; }
        input:focus { border-color: var(--blue); }

        /* ELEMENTOS DIN√ÅMICOS */
        .vote-card { background: var(--card); padding: 15px; margin-bottom: 10px; border-radius: 12px; border: 2px solid transparent; cursor: pointer; position: relative; }
        .vote-card.selected { border-color: var(--accent); background: rgba(255,0,64,0.1); }
        .vote-card b { color: var(--blue); font-size: 1.1rem; }
        .vote-card i { font-size: 0.9rem; color: #aaa; display: block; margin-top: 5px; }
        .vote-badge { position: absolute; right: 15px; top: 15px; background: var(--accent); padding: 2px 8px; border-radius: 20px; font-size: 0.7rem; display: none; }

        .msg { background: #1e1e2e; padding: 12px; border-radius: 15px; margin-bottom: 10px; width: fit-content; max-width: 85%; font-size: 0.95rem; line-height: 1.4; }
        .msg.mine { background: #3a1a25; margin-left: auto; border-right: 4px solid var(--accent); }
        .msg b { color: var(--blue); font-size: 0.75rem; display: block; margin-bottom: 3px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app-container">
    <div id="scr-home" class="screen active">
        <div class="header" style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h1>IMPOSTOR</h1>
            <p style="letter-spacing: 3px; color: #666;">BATTLE ROYALE</p>
        </div>
        <div class="footer">
            <input type="text" id="inp-name" placeholder="Escribe tu nombre" maxlength="12">
            <div style="height:15px"></div>
            <button class="btn btn-main" onclick="startApp()">Entrar</button>
        </div>
    </div>

    <div id="scr-mode" class="screen">
        <div class="header"><h2>MODO DE JUEGO</h2></div>
        <div class="content" style="display:flex; flex-direction:column; justify-content:center;">
            <button class="btn btn-sec" onclick="setupBots()">ü§ñ Solo vs Bots</button>
            <div style="height:10px"></div>
            <button class="btn btn-main" onclick="nav('scr-online')">üåç Multijugador</button>
        </div>
        <div class="footer"><button class="btn btn-ghost" onclick="nav('scr-home')">Volver</button></div>
    </div>

    <div id="scr-online" class="screen">
        <div class="header"><h2>SALA ONLINE</h2></div>
        <div class="content" style="display:flex; flex-direction:column; justify-content:center;">
            <button class="btn btn-main" onclick="createRoom()">Crear Sala</button>
            <p style="text-align:center; margin:20px; color:#555;">‚Äî O ‚Äî</p>
            <input type="text" id="inp-code" placeholder="C√≥digo" maxlength="4">
            <div style="height:10px"></div>
            <button class="btn btn-sec" onclick="joinRoom()">Unirse</button>
        </div>
        <div class="footer"><button class="btn btn-ghost" onclick="nav('scr-mode')">Atr√°s</button></div>
    </div>

    <div id="scr-lobby" class="screen">
        <div class="header"><p id="lobby-type">SALA</p><h1 id="lbl-code">----</h1></div>
        <div class="content" id="lobby-list"></div>
        <div class="footer"><button id="btn-start" class="btn btn-main btn-disabled" onclick="startGame()">Empezar Partida</button></div>
    </div>

    <div id="scr-game" class="screen">
        <div class="header">
            <p style="margin:0; font-size:0.8rem; color:var(--blue)">TU PALABRA SECRETA</p>
            <h2 id="lbl-word" style="font-size:1.8rem; margin:5px 0;">---</h2>
        </div>
        <div class="content" id="chat-box"></div>
        <div class="footer">
            <input type="text" id="inp-clue" placeholder="Escribe tu pista...">
            <button class="btn btn-main" id="btn-send" onclick="sendClue()" style="margin-top:10px">Enviar Pista</button>
        </div>
    </div>

    <div id="scr-vote" class="screen">
        <div class="header"><h2>¬øQUI√âN MIENTE?</h2><p id="vote-count">Votos: 0/0</p></div>
        <div class="content" id="vote-list"></div>
        <div class="footer"><button id="btn-confirm-vote" class="btn btn-main btn-disabled" onclick="confirmVote()">Confirmar Voto</button></div>
    </div>

    <div id="scr-result" class="screen">
        <div class="header" style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h1 id="res-status">ELIMINADO</h1>
            <h2 id="res-name" style="font-size:2.5rem; color:var(--accent)">---</h2>
            <p id="res-info"></p>
            <div id="res-words" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-top:15px;">
                <p>Inocentes: <b id="res-w1" style="color:var(--blue)"></b></p>
                <p>Impostor: <b id="res-w2" style="color:var(--accent)"></b></p>
            </div>
        </div>
        <div class="footer" id="res-footer"></div>
    </div>
</div>

<script>
// --- DATOS INTEGRADOS ---
const DATA = {
    palabras: [
        {g:"Avi√≥n", i:"Helic√≥ptero", pg:["Tiene alas fijas", "Vuela muy alto", "Lleva muchos pasajeros"], pi:["Tiene h√©lices", "Puede quedarse quieto en el aire", "Vuela bajo"]},
        {g:"Pizza", i:"Hamburguesa", pg:["Es redonda y plana", "Se corta en tri√°ngulos", "Viene en caja cuadrada"], pi:["Tiene pan circular", "Lleva carne en medio", "Se come con las manos"]},
        {g:"Perro", i:"Lobo", pg:["Es el mejor amigo del hombre", "Mueve la cola", "Vive en una casa"], pi:["A√∫lla a la luna", "Vive en una manada", "Es muy salvaje"]},
        {g:"Playa", i:"Piscina", pg:["Hay mucha arena", "El agua es salada", "Hay olas"], pi:["El agua tiene cloro", "Tiene bordes de cemento", "No tiene arena"]},
        {g:"Celular", i:"Computadora", pg:["Cabe en mi bolsillo", "Lo uso para llamadas", "Tiene pantalla t√°ctil peque√±a"], pi:["Tiene un teclado grande", "Se usa en una mesa", "Es m√°s potente"]},
        {g:"Cine", i:"Teatro", pg:["Hay una pantalla gigante", "Comemos palomitas", "Vemos pel√≠culas"], pi:["Los actores est√°n en vivo", "Hay un tel√≥n rojo", "La gente aplaude obras"]}
    ],
    relleno: ["Es algo com√∫n", "Me parece √∫til", "No estoy seguro...", "Lo he visto antes"]
};

let state = {
    mode: 'offline', name: '', id: '', 
    players: [], isHost: false, game: null, 
    peer: null, conns: {}, selectedVote: ''
};

function nav(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function startApp() {
    state.name = document.getElementById('inp-name').value.trim().toUpperCase();
    if(state.name.length < 2) return alert("Nombre muy corto");
    nav('scr-mode');
}

// --- L√ìGICA BOTS ---
function setupBots() {
    state.mode = 'offline'; state.isHost = true; state.id = 'me';
    state.players = [{id:'me', name:state.name, isBot:false, clue:'', votes:0, out:false}];
    nav('scr-lobby');
    document.getElementById('lbl-code').innerText = "BOTS";
    const names = ["SARA-BOT", "ALEX-BOT", "MAX-BOT", "ZARA-BOT", "NEO-BOT"];
    names.forEach((n, i) => {
        setTimeout(() => {
            state.players.push({id:'b'+i, name:n, isBot:true, clue:'', votes:0, out:false});
            renderLobby();
        }, 300 * i);
    });
}

function renderLobby() {
    const list = document.getElementById('lobby-list');
    const alive = state.players.filter(p => !p.out);
    list.innerHTML = alive.map(p => `<div class="vote-card" style="cursor:default"><b>${p.name}</b></div>`).join('');
    if(state.isHost && alive.length >= 3) document.getElementById('btn-start').classList.remove('btn-disabled');
}

// --- ELIMINACI√ìN Y RONDAS ---
function startGame() {
    const alive = state.players.filter(p => !p.out);
    if(alive.length < 2) return alert("Fin del juego");

    state.players.forEach(p => { p.clue = ''; p.votes = 0; });
    
    const p = DATA.palabras[Math.floor(Math.random() * DATA.palabras.length)];
    const impIdx = Math.floor(Math.random() * alive.length);
    state.game = { g: p.g, i: p.i, impId: alive[impIdx].id, impName: alive[impIdx].name, wordData: p };

    alive.forEach(pl => {
        const word = (pl.id === state.game.impId) ? p.i : p.g;
        if(pl.id === state.id) {
            nav('scr-game');
            document.getElementById('lbl-word').innerText = word;
            document.getElementById('chat-box').innerHTML = '';
            document.getElementById('btn-send').classList.remove('btn-disabled');
        }
        if(state.mode === 'online' && !pl.isBot && pl.id !== state.id) {
            state.conns[pl.id].send({type:'START', word: word, game: state.game});
        }
    });

    if(state.mode === 'offline') simulateBotClues();
}

function simulateBotClues() {
    const aliveBots = state.players.filter(p => p.isBot && !p.out);
    aliveBots.forEach(b => {
        setTimeout(() => {
            const isImp = (b.id === state.game.impId);
            const pool = isImp ? state.game.wordData.pi : state.game.wordData.pg;
            b.clue = pool[Math.floor(Math.random() * pool.length)];
            addChat(b.name, b.clue, false);
            checkAllClues();
        }, Math.random() * 5000 + 2000);
    });
}

function sendClue() {
    const val = document.getElementById('inp-clue').value.trim();
    if(!val) return;
    document.getElementById('inp-clue').value = '';
    document.getElementById('btn-send').classList.add('btn-disabled');
    
    const me = state.players.find(p => p.id === state.id);
    me.clue = val;
    addChat(state.name, val, true);

    if(state.mode === 'online') {
        if(state.isHost) broadcast({type:'CHAT', name:state.name, txt:val, pid:state.id});
        else state.conns['host'].send({type:'CLUE', name:state.name, txt:val});
    }
    checkAllClues();
}

function addChat(n, t, mine) {
    const b = document.getElementById('chat-box');
    b.innerHTML += `<div class="msg ${mine?'mine':''}"><b>${n}</b>${t}</div>`;
    b.scrollTop = b.scrollHeight;
}

function checkAllClues() {
    const alive = state.players.filter(p => !p.out);
    if(alive.every(p => p.clue !== '')) {
        setTimeout(startVote, 1500);
    }
}

function startVote() {
    nav('scr-vote');
    const alive = state.players.filter(p => !p.out);
    document.getElementById('vote-list').innerHTML = alive.map(p => `
        <div class="vote-card" id="vc-${p.id}" onclick="selectVote('${p.id}')">
            <b>${p.name}</b>
            <i>"${p.clue}"</i>
            <span class="vote-badge" id="badge-${p.id}">0</span>
        </div>
    `).join('');
    document.getElementById('vote-count').innerText = `Votos: 0 / ${alive.length}`;
    document.getElementById('btn-confirm-vote').classList.add('btn-disabled');
    document.getElementById('btn-confirm-vote').style.display = 'block';

    if(state.mode === 'offline') simulateBotVotes();
    if(state.mode === 'online' && state.isHost) broadcast({type:'VOTE_TIME'});
}

function selectVote(id) {
    state.selectedVote = id;
    document.querySelectorAll('.vote-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('vc-'+id).classList.add('selected');
    document.getElementById('btn-confirm-vote').classList.remove('btn-disabled');
}

function confirmVote() {
    document.getElementById('btn-confirm-vote').style.display = 'none';
    if(state.isHost || state.mode === 'offline') processVote(state.selectedVote);
    else state.conns['host'].send({type:'VOTE', tid: state.selectedVote});
}

function processVote(tid) {
    const target = state.players.find(p => p.id === tid);
    target.votes++;
    const alive = state.players.filter(p => !p.out);
    const total = alive.reduce((a,b) => a + b.votes, 0);
    
    const update = {type:'VOTE_UPD', tid: tid, count: target.votes, total: total};
    if(state.mode === 'online' && state.isHost) broadcast(update);
    updateVoteUI(update);

    if(total >= alive.length) setTimeout(finalizeRound, 2000);
}

function updateVoteUI(d) {
    const badge = document.getElementById('badge-'+d.tid);
    if(badge) { badge.innerText = d.count; badge.style.display = 'block'; }
    document.getElementById('vote-count').innerText = `Votos: ${d.total} / ${state.players.filter(p=>!p.out).length}`;
}

function simulateBotVotes() {
    const alive = state.players.filter(p => !p.out);
    alive.filter(p => p.isBot).forEach(b => {
        setTimeout(() => processVote(alive[Math.floor(Math.random()*alive.length)].id), Math.random()*6000 + 1000);
    });
}

function finalizeRound() {
    const alive = state.players.filter(p => !p.out);
    const sorted = [...alive].sort((a,b) => b.votes - a.votes);
    const expelled = sorted[0];
    expelled.out = true;

    const res = {
        type:'RESULT', name: expelled.name, eid: expelled.id, 
        impName: state.game.impName, g: state.game.g, i: state.game.i
    };
    if(state.mode === 'online' && state.isHost) broadcast(res);
    showResult(res);
}

function showResult(d) {
    nav('scr-result');
    document.getElementById('res-name').innerText = d.name;
    document.getElementById('res-w1').innerText = d.g;
    document.getElementById('res-w2').innerText = d.i;
    
    const footer = document.getElementById('res-footer');
    if(d.eid === state.id) {
        document.getElementById('res-status').innerText = "EST√ÅS ELIMINADO";
        footer.innerHTML = `<button class="btn btn-main" onclick="location.reload()">Salir al Men√∫</button>`;
    } else {
        document.getElementById('res-status').innerText = "ELIMINADO";
        const alive = state.players.filter(p => !p.out);
        if(alive.length <= 1) {
            document.getElementById('res-status').innerText = "¬°GANADOR FINAL!";
            document.getElementById('res-name').innerText = alive[0].name;
            footer.innerHTML = `<button class="btn btn-main" onclick="location.reload()">Nuevo Juego</button>`;
        } else {
            footer.innerHTML = `<p style="text-align:center">Siguiente ronda en 5 segundos...</p>`;
            if(state.isHost) setTimeout(startGame, 5000);
        }
    }
}

// --- ONLINE (PEERJS) ---
function broadcast(d) { Object.values(state.conns).forEach(c => c.send(d)); }

function createRoom() {
    state.mode = 'online'; state.isHost = true;
    const code = Math.random().toString(36).substring(2,6).toUpperCase();
    state.peer = new Peer("IMP6-"+code);
    state.peer.on('open', id => {
        state.id = id;
        state.players = [{id:id, name:state.name, isBot:false, clue:'', votes:0, out:false}];
        nav('scr-lobby');
        document.getElementById('lbl-code').innerText = code;
        renderLobby();
    });
    state.peer.on('connection', c => {
        c.on('data', d => {
            if(d.type === 'JOIN') {
                state.conns[c.peer] = c;
                state.players.push({id:c.peer, name:d.name, isBot:false, clue:'', votes:0, out:false});
                broadcast({type:'SYNC', players: state.players});
                renderLobby();
            }
            if(d.type === 'CLUE') {
                const p = state.players.find(x => x.id === c.peer);
                p.clue = d.txt; addChat(d.name, d.txt, false);
                broadcast({type:'CHAT', name:d.name, txt:d.txt, pid:c.peer});
                checkAllClues();
            }
            if(d.type === 'VOTE') processVote(d.tid);
        });
    });
}

function joinRoom() {
    const code = document.getElementById('inp-code').value.toUpperCase();
    state.peer = new Peer();
    state.peer.on('open', id => {
        state.id = id;
        const c = state.peer.connect("IMP6-"+code);
        state.conns['host'] = c;
        c.on('open', () => {
            c.send({type:'JOIN', name: state.name});
            nav('scr-lobby');
            document.getElementById('lbl-code').innerText = code;
        });
        c.on('data', d => {
            if(d.type === 'SYNC') { state.players = d.players; renderLobby(); }
            if(d.type === 'START') { 
                state.game = d.game; 
                nav('scr-game'); 
                document.getElementById('lbl-word').innerText = d.word; 
                document.getElementById('chat-box').innerHTML = '';
            }
            if(d.type === 'CHAT') addChat(d.name, d.txt, d.pid === state.id);
            if(d.type === 'VOTE_TIME') startVote();
            if(d.type === 'VOTE_UPD') updateVoteUI(d);
            if(d.type === 'RESULT') showResult(d);
        });
    });
}
</script>
</body>
</html>
